craft_android_x86_64:
  stage: deploy
  when: manual
  image: kdeorg/android-qt515:latest
  #needs: ["android_qt515"]
  tags:
    - Linux
  variables:
    GIT_STRATEGY: none
    KDECI_CRAFT_PLATFORM: android-x86_64-clang
    KDECI_CRAFT_CACHE: /mnt/craft-cache/$KDECI_CRAFT_PLATFORM/
    KDECI_CRAFT_CONFIG: ci-utilities/resources/CraftConfig.ini
  interruptible: true
  before_script:
    - git clone $CI_REPOSITORY_URL --branch=$CI_COMMIT_REF_NAME src/
    - git clone https://invent.kde.org/packaging/craftmaster --branch=master
    - git clone https://invent.kde.org/sysadmin/ci-utilities
  script:
    # Get Craft itself ready
    - python3 craftmaster/CraftMaster.py --config $KDECI_CRAFT_CONFIG --target $KDECI_CRAFT_PLATFORM -c -i --options virtual.ignored=True --update craft
    # Install all of our dependencies
    - python3 craftmaster/CraftMaster.py --config $KDECI_CRAFT_CONFIG --target $KDECI_CRAFT_PLATFORM -c --install-deps $CI_PROJECT_NAME
    # Build the actual application
    - python3 craftmaster/CraftMaster.py --config $KDECI_CRAFT_CONFIG --target $KDECI_CRAFT_PLATFORM -c --no-cache --target master --src-dir $CI_PROJECT_DIR/src/ $CI_PROJECT_NAME
    # Ensure the tools needed to conduct packaging are installed
    - python3 craftmaster/CraftMaster.py --config $KDECI_CRAFT_CONFIG --target $KDECI_CRAFT_PLATFORM -c -i --update linuxdeploy
    # Package it up!
    - python3 craftmaster/CraftMaster.py --config $KDECI_CRAFT_CONFIG --target $KDECI_CRAFT_PLATFORM -c --package --target master --src-dir $CI_PROJECT_DIR/src/ $CI_PROJECT_NAME
    # Save our package
    - packageDir=$(python3 "craftmaster/CraftMaster.py" --config $KDECI_CRAFT_CONFIG --target $KDECI_CRAFT_PLATFORM -c -q --get "packageDestinationDir()" virtual/base)
    - mkdir $CI_PROJECT_DIR/.kde-ci-packages/
    - cp -vf $packageDir/* $CI_PROJECT_DIR/.kde-ci-packages/
  artifacts:
    expire_in: 3 days
    when: on_success
    expose_as: "Android (x86-64)"
    paths:
     - ".kde-ci-packages/"
